#!/usr/bin/env python3
import argparse, sys, os
import subprocess
import time
from notify import notification

sys.path.append(os.path.expanduser("~/.dotfiles/python/modules"))
import dotfiles

parser = argparse.ArgumentParser()

parser.add_argument("target", nargs="?")

parser.add_argument(
    "--full",
    action=argparse.BooleanOptionalAction,
)

parser.add_argument(
    "--area",
    action=argparse.BooleanOptionalAction,
)

parser.add_argument(
    "--window",
    action=argparse.BooleanOptionalAction,
)

parser.add_argument(
    "--chrome",
    action=argparse.BooleanOptionalAction,
)

args = parser.parse_args()

if (
    not args.target
    and not args.full
    and not args.area
    and not args.window
    and not args.chrome
):
    print("Need to select one of target / full / area / window / chrome")
    exit(1)

extension = args.target.split(".")[-1] if args.target else "png"
name = dotfiles.generate_filename(extension)


def scp_to_server(path):
    dotfiles.upload_to_server(path, name, "sway_scrotshare")


def handle_target(path, adhoc):
    options = ["push", "keep", "clipboard", "gimp"]

    result = dotfiles.rofi.dmenu(options)

    if result in options:
        if result == "push":
            scp_to_server(path)
        elif result == "clipboard":
            os.system("wl-copy < " + path)

            notification(
                "sway_scrotshare",
                message="Screenshot copied to clipboard.",
                app_name="sway",
            )
        elif result == "gimp":
            os.system("gimp " + path + " &")
            time.sleep(3)
        elif result == "keep":
            notification(
                "sway_scrotshare",
                message="Screenshot kept at " + path + ".",
                app_name="sway",
            )

    if adhoc and result != "keep":
        os.remove(path)


if args.target:
    handle_target(args.target, False)
else:
    path = os.path.expanduser("~/Pictures/" + name)

    # Determine mode and crop
    if args.area:
        mode = "area"
        crop = 0
    elif args.full:
        mode = "full"
        crop = 0
    elif args.window or args.chrome:
        mode = "window"
        crop = 121 if args.chrome else 0
    else:
        print("No mode selected")
        exit(1)

    try:
        selection = dotfiles.get_sway_selection(mode, crop)
    except dotfiles.SwaySelectionError as e:
        print(str(e))
        exit(1)

    # Format grim args based on selection type
    if selection["type"] == "area":
        grim_args = "-g '" + selection["geometry"] + "'"
    elif selection["type"] == "full":
        grim_args = "-o '" + selection["output_name"] + "'"
    elif selection["type"] == "window":
        grim_args = "-g '" + selection["geometry"] + "'"

    grim_command = "grim " + grim_args + " " + path
    grim_result = subprocess.run(
        grim_command, shell=True, capture_output=True, text=True
    )

    if grim_result.returncode != 0:
        print("Failed grim with " + grim_command.stdout)
        exit(1)

    handle_target(path, True)
